(function(){"use strict";var q=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function D(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var O={exports:{}};(function(e,n){(function(t,g){g(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:q,function(t){var g,l;if(!((l=(g=globalThis.chrome)==null?void 0:g.runtime)!=null&&l.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const m="The message port closed before a response was received.",w=p=>{const y={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(y).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class h extends WeakMap{constructor(s,o=void 0){super(o),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const C=r=>r&&typeof r=="object"&&typeof r.then=="function",j=(r,s)=>(...o)=>{p.runtime.lastError?r.reject(new Error(p.runtime.lastError.message)):s.singleCallbackArg||o.length<=1&&s.singleCallbackArg!==!1?r.resolve(o[0]):r.resolve(o)},v=r=>r==1?"argument":"arguments",X=(r,s)=>function(i,...u){if(u.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${v(s.minArgs)} for ${r}(), got ${u.length}`);if(u.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${v(s.maxArgs)} for ${r}(), got ${u.length}`);return new Promise((d,x)=>{if(s.fallbackToNoCallback)try{i[r](...u,j({resolve:d,reject:x},s))}catch(a){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),i[r](...u),s.fallbackToNoCallback=!1,s.noCallback=!0,d()}else s.noCallback?(i[r](...u),d()):i[r](...u,j({resolve:d,reject:x},s))})},F=(r,s,o)=>new Proxy(s,{apply(i,u,d){return o.call(u,r,...d)}});let T=Function.call.bind(Object.prototype.hasOwnProperty);const E=(r,s={},o={})=>{let i=Object.create(null),u={has(x,a){return a in r||a in i},get(x,a,f){if(a in i)return i[a];if(!(a in r))return;let A=r[a];if(typeof A=="function")if(typeof s[a]=="function")A=F(r,r[a],s[a]);else if(T(o,a)){let b=X(a,o[a]);A=F(r,r[a],b)}else A=A.bind(r);else if(typeof A=="object"&&A!==null&&(T(s,a)||T(o,a)))A=E(A,s[a],o[a]);else if(T(o,"*"))A=E(A,s[a],o["*"]);else return Object.defineProperty(i,a,{configurable:!0,enumerable:!0,get(){return r[a]},set(b){r[a]=b}}),A;return i[a]=A,A},set(x,a,f,A){return a in i?i[a]=f:r[a]=f,!0},defineProperty(x,a,f){return Reflect.defineProperty(i,a,f)},deleteProperty(x,a){return Reflect.deleteProperty(i,a)}},d=Object.create(r);return new Proxy(d,u)},M=r=>({addListener(s,o,...i){s.addListener(r.get(o),...i)},hasListener(s,o){return s.hasListener(r.get(o))},removeListener(s,o){s.removeListener(r.get(o))}}),Y=new h(r=>typeof r!="function"?r:function(o){const i=E(o,{},{getContent:{minArgs:0,maxArgs:0}});r(i)}),W=new h(r=>typeof r!="function"?r:function(o,i,u){let d=!1,x,a=new Promise(P=>{x=function(k){d=!0,P(k)}}),f;try{f=r(o,i,x)}catch(P){f=Promise.reject(P)}const A=f!==!0&&C(f);if(f!==!0&&!A&&!d)return!1;const b=P=>{P.then(k=>{u(k)},k=>{let $;k&&(k instanceof Error||typeof k.message=="string")?$=k.message:$="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:$})}).catch(k=>{console.error("Failed to send onMessage rejected reply",k)})};return b(A?f:a),!0}),ee=({reject:r,resolve:s},o)=>{p.runtime.lastError?p.runtime.lastError.message===m?s():r(new Error(p.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?r(new Error(o.message)):s(o)},B=(r,s,o,...i)=>{if(i.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${v(s.minArgs)} for ${r}(), got ${i.length}`);if(i.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${v(s.maxArgs)} for ${r}(), got ${i.length}`);return new Promise((u,d)=>{const x=ee.bind(null,{resolve:u,reject:d});i.push(x),o.sendMessage(...i)})},re={devtools:{network:{onRequestFinished:M(Y)}},runtime:{onMessage:M(W),onMessageExternal:M(W),sendMessage:B.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:B.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},U={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return y.privacy={network:{"*":U},services:{"*":U},websites:{"*":U}},E(p,re,y)};t.exports=w(chrome)}else t.exports=globalThis.browser})})(O);var H=O.exports;const c=D(H),I="https://www.getpawkit.com/api",G="www.getpawkit.com";async function R(){try{const e=await c.cookies.getAll({domain:G});if(e.length===0){const n=await c.cookies.getAll({domain:"getpawkit.com"});if(n.length>0)return n.map(t=>`${t.name}=${t.value}`).join("; ")}return e.map(n=>`${n.name}=${n.value}`).join("; ")}catch(e){return console.error("Failed to get cookies:",e),""}}async function J(){try{return(await c.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(e){return console.error("Failed to get workspace:",e),null}}async function Z(e){await c.storage.local.set({pawkit_workspace:e})}async function z(e,n,t=!1){try{const l={Cookie:await R()};let m;t?m=n:(l["Content-Type"]="application/json",m=JSON.stringify(n));const w=await fetch(`${I}${e}`,{method:"POST",headers:l,body:m});if(w.status===401)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};if(!w.ok){const y=await w.text();let h=`API error: ${w.status} ${w.statusText}`;try{const C=JSON.parse(y);h=C.message||C.error||h}catch{}return{ok:!1,error:h}}return{ok:!0,data:await w.json()}}catch(g){return console.error("API request failed:",g),{ok:!1,error:g instanceof Error?g.message:"Network request failed"}}}async function S(e){try{const n=await R(),t=await fetch(`${I}${e}`,{method:"GET",headers:{Cookie:n}});if(t.status===401)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};if(!t.ok){const l=await t.text();let m=`API error: ${t.status}`;try{const w=JSON.parse(l);m=w.message||w.error||m}catch{}return{ok:!1,error:m}}return{ok:!0,data:await t.json()}}catch(n){return console.error("API GET request failed:",n),{ok:!1,error:n instanceof Error?n.message:"Network request failed"}}}async function K(){var n;const e=await S("/workspaces");if(e.ok&&((n=e.data)!=null&&n.workspaces)){const t=e.data.workspaces.find(g=>g.isDefault)||e.data.workspaces[0];return t?(await Z(t),{ok:!0,data:t}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:e.error||"Failed to fetch workspaces"}}async function L(){const e=await J();if(e)return e.id;const n=await K();return n.ok&&n.data?n.data.id:null}async function V(){const e=await S("/workspaces");return e.ok?{ok:!0}:{ok:!1,error:e.error}}async function N(e){const n=await L();if(!n)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const{meta:t,...g}=e;return z("/cards",{...g,workspaceId:n,type:"url",source:{type:"webext"},image:t==null?void 0:t.ogImage,description:t==null?void 0:t.description,favicon:t==null?void 0:t.favicon})}async function Q(){var t;const e=await L();if(!e)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const n=await S(`/collections?workspaceId=${e}`);return n.ok&&((t=n.data)!=null&&t.collections)?{ok:!0,data:n.data.collections.map(l=>({id:l.id,name:l.name,emoji:l.icon||null,slug:l.slug||l.id}))}:{ok:!1,error:n.error||"Failed to fetch collections"}}c.runtime.onInstalled.addListener(()=>{c.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),c.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("Pawkit Web Clipper installed")}),c.contextMenus.onClicked.addListener(async(e,n)=>{if(n!=null&&n.id)try{if(e.menuItemId==="save-to-pawkit"){const t=(e.linkUrl||e.pageUrl||n.url)??"",g=e.linkUrl?new URL(e.linkUrl).hostname:n.title||"Untitled",l=await N({title:g,url:t,source:"webext"});_(l,g)}else if(e.menuItemId==="save-image-to-pawkit"&&e.srcUrl){const t=n.url||"",g=e.srcUrl,l=n.title||"Untitled",m=await N({title:l,url:t,source:"webext",notes:`Image URL: ${g}`,meta:{ogImage:g}});_(m,l)}}catch(t){console.error("Context menu save failed:",t)}});function _(e,n){var t,g;e.ok?(t=c.notifications)==null||t.create({type:"basic",iconUrl:c.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${n}" has been saved to your Pawkit`}):(g=c.notifications)==null||g.create({type:"basic",iconUrl:c.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:e.error||"Failed to save to Pawkit"})}c.runtime.onMessage.addListener((e,n)=>{var t,g;if(e.type==="REOPEN_POPUP"){(t=c.action)!=null&&t.openPopup?c.action.openPopup().catch(()=>{var l;(l=c.notifications)==null||l.create({type:"basic",iconUrl:c.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(g=c.notifications)==null||g.create({type:"basic",iconUrl:c.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return new Promise(async l=>{try{switch(e.type){case"SAVE_CARD":{const m=await N(e.payload);l(m);break}case"CHECK_AUTH":{const m=await V();l(m);break}case"GET_COLLECTIONS":{const m=await Q();l(m);break}default:l({ok:!1,error:"Unknown message type"})}}catch(m){console.error("Message handler error:",m),l({ok:!1,error:m instanceof Error?m.message:"Unknown error"})}})}),console.log("Pawkit service worker running")})();

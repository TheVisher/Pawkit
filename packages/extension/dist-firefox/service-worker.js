(function(){"use strict";var W=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function B(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var F={exports:{}};(function(e,i){(function(t,l){l(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:W,function(t){var l,o;if(!((o=(l=globalThis.chrome)==null?void 0:l.runtime)!=null&&o.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const A="The message port closed before a response was received.",y=w=>{const p={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(p).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class _ extends WeakMap{constructor(s,a=void 0){super(a),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const J=r=>r&&typeof r=="object"&&typeof r.then=="function",O=(r,s)=>(...a)=>{w.runtime.lastError?r.reject(new Error(w.runtime.lastError.message)):s.singleCallbackArg||a.length<=1&&s.singleCallbackArg!==!1?r.resolve(a[0]):r.resolve(a)},P=r=>r==1?"argument":"arguments",X=(r,s)=>function(g,...u){if(u.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${P(s.minArgs)} for ${r}(), got ${u.length}`);if(u.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${P(s.maxArgs)} for ${r}(), got ${u.length}`);return new Promise((d,x)=>{if(s.fallbackToNoCallback)try{g[r](...u,O({resolve:d,reject:x},s))}catch(n){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,n),g[r](...u),s.fallbackToNoCallback=!1,s.noCallback=!0,d()}else s.noCallback?(g[r](...u),d()):g[r](...u,O({resolve:d,reject:x},s))})},I=(r,s,a)=>new Proxy(s,{apply(g,u,d){return a.call(u,r,...d)}});let v=Function.call.bind(Object.prototype.hasOwnProperty);const C=(r,s={},a={})=>{let g=Object.create(null),u={has(x,n){return n in r||n in g},get(x,n,f){if(n in g)return g[n];if(!(n in r))return;let c=r[n];if(typeof c=="function")if(typeof s[n]=="function")c=I(r,r[n],s[n]);else if(v(a,n)){let b=X(n,a[n]);c=I(r,r[n],b)}else c=c.bind(r);else if(typeof c=="object"&&c!==null&&(v(s,n)||v(a,n)))c=C(c,s[n],a[n]);else if(v(a,"*"))c=C(c,s[n],a["*"]);else return Object.defineProperty(g,n,{configurable:!0,enumerable:!0,get(){return r[n]},set(b){r[n]=b}}),c;return g[n]=c,c},set(x,n,f,c){return n in g?g[n]=f:r[n]=f,!0},defineProperty(x,n,f){return Reflect.defineProperty(g,n,f)},deleteProperty(x,n){return Reflect.deleteProperty(g,n)}},d=Object.create(r);return new Proxy(d,u)},U=r=>({addListener(s,a,...g){s.addListener(r.get(a),...g)},hasListener(s,a){return s.hasListener(r.get(a))},removeListener(s,a){s.removeListener(r.get(a))}}),Y=new _(r=>typeof r!="function"?r:function(a){const g=C(a,{},{getContent:{minArgs:0,maxArgs:0}});r(g)}),$=new _(r=>typeof r!="function"?r:function(a,g,u){let d=!1,x,n=new Promise(h=>{x=function(k){d=!0,h(k)}}),f;try{f=r(a,g,x)}catch(h){f=Promise.reject(h)}const c=f!==!0&&J(f);if(f!==!0&&!c&&!d)return!1;const b=h=>{h.then(k=>{u(k)},k=>{let R;k&&(k instanceof Error||typeof k.message=="string")?R=k.message:R="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:R})}).catch(k=>{console.error("Failed to send onMessage rejected reply",k)})};return b(c?f:n),!0}),ee=({reject:r,resolve:s},a)=>{w.runtime.lastError?w.runtime.lastError.message===A?s():r(new Error(w.runtime.lastError.message)):a&&a.__mozWebExtensionPolyfillReject__?r(new Error(a.message)):s(a)},j=(r,s,a,...g)=>{if(g.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${P(s.minArgs)} for ${r}(), got ${g.length}`);if(g.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${P(s.maxArgs)} for ${r}(), got ${g.length}`);return new Promise((u,d)=>{const x=ee.bind(null,{resolve:u,reject:d});g.push(x),a.sendMessage(...g)})},re={devtools:{network:{onRequestFinished:U(Y)}},runtime:{onMessage:U($),onMessageExternal:U($),sendMessage:j.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:j.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},M={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return p.privacy={network:{"*":M},services:{"*":M},websites:{"*":M}},C(w,re,p)};t.exports=y(chrome)}else t.exports=globalThis.browser})})(F);var q=F.exports;const m=B(q);async function D(){try{const e=await m.tabs.query({url:["https://getpawkit.com/*","https://www.getpawkit.com/*"]});return e.length>0&&e[0].id?e[0].id:null}catch(e){return console.error("Failed to find Pawkit tab:",e),null}}async function T(e,i,t){const l=await D();if(!l)return{ok:!1,error:"Please open getpawkit.com in a tab and log in first."};try{return await m.tabs.sendMessage(l,{type:"API_REQUEST",method:e,path:i,body:t})}catch(o){return console.error("Bridge request failed:",o),{ok:!1,error:"Failed to communicate with Pawkit tab. Please refresh getpawkit.com and try again."}}}async function G(){try{return(await m.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(e){return console.error("Failed to get workspace:",e),null}}async function H(e){await m.storage.local.set({pawkit_workspace:e})}async function V(e,i,t=!1){return t?{ok:!1,error:"Form uploads not supported"}:T("POST",e,i)}async function E(e){return T("GET",e)}async function Z(e){return T("POST","/metadata",{url:e})}async function z(){var i;const e=await E("/workspaces");if(e.ok&&((i=e.data)!=null&&i.workspaces)){const t=e.data.workspaces.find(l=>l.isDefault)||e.data.workspaces[0];return t?(await H(t),{ok:!0,data:t}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:e.error||"Failed to fetch workspaces"}}async function L(){const e=await G();if(e)return e.id;const i=await z();return i.ok&&i.data?i.data.id:null}async function K(){const e=await E("/workspaces");return e.ok?{ok:!0}:{ok:!1,error:e.error}}async function S(e){const i=await L();if(!i)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const{meta:t,...l}=e;let o=t==null?void 0:t.ogImage,A=t==null?void 0:t.description,y=t==null?void 0:t.favicon,w=null;if(!o&&e.url){console.log("[Extension] Fetching metadata for:",e.url);const p=await Z(e.url);p.ok&&p.data&&(o=p.data.image||void 0,A=p.data.description||void 0,y=p.data.favicon||void 0,w=p.data.title,console.log("[Extension] Metadata fetched:",{image:!!o,description:!!A}))}return V("/cards",{...l,title:l.title===e.url&&w?w:l.title,workspaceId:i,type:"url",source:{type:"webext"},image:o,description:A,favicon:y})}async function Q(){var t;const e=await L();if(!e)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const i=await E(`/collections?workspaceId=${e}`);return i.ok&&((t=i.data)!=null&&t.collections)?{ok:!0,data:i.data.collections.map(o=>({id:o.id,name:o.name,emoji:o.icon||null,slug:o.slug||o.id}))}:{ok:!1,error:i.error||"Failed to fetch collections"}}m.runtime.onInstalled.addListener(()=>{m.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),m.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("Pawkit Web Clipper installed")}),m.contextMenus.onClicked.addListener(async(e,i)=>{if(i!=null&&i.id)try{if(e.menuItemId==="save-to-pawkit"){const t=(e.linkUrl||e.pageUrl||i.url)??"",l=e.linkUrl?new URL(e.linkUrl).hostname:i.title||"Untitled",o=await S({title:l,url:t,source:"webext"});N(o,l)}else if(e.menuItemId==="save-image-to-pawkit"&&e.srcUrl){const t=i.url||"",l=e.srcUrl,o=i.title||"Untitled",A=await S({title:o,url:t,source:"webext",notes:`Image URL: ${l}`,meta:{ogImage:l}});N(A,o)}}catch(t){console.error("Context menu save failed:",t)}});function N(e,i){var t,l;e.ok?(t=m.notifications)==null||t.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${i}" has been saved to your Pawkit`}):(l=m.notifications)==null||l.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:e.error||"Failed to save to Pawkit"})}m.runtime.onMessage.addListener((e,i)=>{var t,l;if(e.type==="REOPEN_POPUP"){(t=m.action)!=null&&t.openPopup?m.action.openPopup().catch(()=>{var o;(o=m.notifications)==null||o.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(l=m.notifications)==null||l.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return new Promise(async o=>{try{switch(e.type){case"SAVE_CARD":{const A=await S(e.payload);o(A);break}case"CHECK_AUTH":{const A=await K();o(A);break}case"GET_COLLECTIONS":{const A=await Q();o(A);break}default:o({ok:!1,error:"Unknown message type"})}}catch(A){console.error("Message handler error:",A),o({ok:!1,error:A instanceof Error?A.message:"Unknown error"})}})}),console.log("Pawkit service worker running")})();

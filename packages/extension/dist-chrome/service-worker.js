(function(){"use strict";var W=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function B(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var M={exports:{}};(function(r,t){(function(n,i){i(r)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:W,function(n){var i,g;if(!((g=(i=globalThis.chrome)==null?void 0:i.runtime)!=null&&g.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const m="The message port closed before a response was received.",I=k=>{const p={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(p).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class h extends WeakMap{constructor(s,o=void 0){super(o),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const V=e=>e&&typeof e=="object"&&typeof e.then=="function",O=(e,s)=>(...o)=>{k.runtime.lastError?e.reject(new Error(k.runtime.lastError.message)):s.singleCallbackArg||o.length<=1&&s.singleCallbackArg!==!1?e.resolve(o[0]):e.resolve(o)},P=e=>e==1?"argument":"arguments",K=(e,s)=>function(l,...u){if(u.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${P(s.minArgs)} for ${e}(), got ${u.length}`);if(u.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${P(s.maxArgs)} for ${e}(), got ${u.length}`);return new Promise((x,d)=>{if(s.fallbackToNoCallback)try{l[e](...u,O({resolve:x,reject:d},s))}catch(a){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),l[e](...u),s.fallbackToNoCallback=!1,s.noCallback=!0,x()}else s.noCallback?(l[e](...u),x()):l[e](...u,O({resolve:x,reject:d},s))})},_=(e,s,o)=>new Proxy(s,{apply(l,u,x){return o.call(u,e,...x)}});let C=Function.call.bind(Object.prototype.hasOwnProperty);const T=(e,s={},o={})=>{let l=Object.create(null),u={has(d,a){return a in e||a in l},get(d,a,f){if(a in l)return l[a];if(!(a in e))return;let c=e[a];if(typeof c=="function")if(typeof s[a]=="function")c=_(e,e[a],s[a]);else if(C(o,a)){let b=K(a,o[a]);c=_(e,e[a],b)}else c=c.bind(e);else if(typeof c=="object"&&c!==null&&(C(s,a)||C(o,a)))c=T(c,s[a],o[a]);else if(C(o,"*"))c=T(c,s[a],o["*"]);else return Object.defineProperty(l,a,{configurable:!0,enumerable:!0,get(){return e[a]},set(b){e[a]=b}}),c;return l[a]=c,c},set(d,a,f,c){return a in l?l[a]=f:e[a]=f,!0},defineProperty(d,a,f){return Reflect.defineProperty(l,a,f)},deleteProperty(d,a){return Reflect.deleteProperty(l,a)}},x=Object.create(e);return new Proxy(x,u)},S=e=>({addListener(s,o,...l){s.addListener(e.get(o),...l)},hasListener(s,o){return s.hasListener(e.get(o))},removeListener(s,o){s.removeListener(e.get(o))}}),Q=new h(e=>typeof e!="function"?e:function(o){const l=T(o,{},{getContent:{minArgs:0,maxArgs:0}});e(l)}),F=new h(e=>typeof e!="function"?e:function(o,l,u){let x=!1,d,a=new Promise(y=>{d=function(w){x=!0,y(w)}}),f;try{f=e(o,l,d)}catch(y){f=Promise.reject(y)}const c=f!==!0&&V(f);if(f!==!0&&!c&&!x)return!1;const b=y=>{y.then(w=>{u(w)},w=>{let U;w&&(w instanceof Error||typeof w.message=="string")?U=w.message:U="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:U})}).catch(w=>{console.error("Failed to send onMessage rejected reply",w)})};return b(c?f:a),!0}),X=({reject:e,resolve:s},o)=>{k.runtime.lastError?k.runtime.lastError.message===m?s():e(new Error(k.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?e(new Error(o.message)):s(o)},j=(e,s,o,...l)=>{if(l.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${P(s.minArgs)} for ${e}(), got ${l.length}`);if(l.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${P(s.maxArgs)} for ${e}(), got ${l.length}`);return new Promise((u,x)=>{const d=X.bind(null,{resolve:u,reject:x});l.push(d),o.sendMessage(...l)})},Y={devtools:{network:{onRequestFinished:S(Q)}},runtime:{onMessage:S(F),onMessageExternal:S(F),sendMessage:j.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:j.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},N={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return p.privacy={network:{"*":N},services:{"*":N},websites:{"*":N}},T(k,Y,p)};n.exports=I(chrome)}else n.exports=globalThis.browser})})(M);var q=M.exports;const A=B(q),$="https://www.getpawkit.com/api";async function D(){try{return(await A.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(r){return console.error("Failed to get workspace:",r),null}}async function G(r){await A.storage.local.set({pawkit_workspace:r})}async function J(r,t,n=!1){try{const i={};let g;n?g=t:(i["Content-Type"]="application/json",g=JSON.stringify(t));const m=await fetch(`${$}${r}`,{method:"POST",headers:i,body:g,credentials:"include"});if(m.status===401)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};if(!m.ok){const k=await m.text();let p=`API error: ${m.status} ${m.statusText}`;try{const h=JSON.parse(k);p=h.message||h.error||p}catch{}return{ok:!1,error:p}}return{ok:!0,data:await m.json()}}catch(i){return console.error("API request failed:",i),{ok:!1,error:i instanceof Error?i.message:"Network request failed"}}}async function v(r){try{const t=await fetch(`${$}${r}`,{method:"GET",credentials:"include"});if(t.status===401)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};if(!t.ok){const i=await t.text();let g=`API error: ${t.status}`;try{const m=JSON.parse(i);g=m.message||m.error||g}catch{}return{ok:!1,error:g}}return{ok:!0,data:await t.json()}}catch(t){return console.error("API GET request failed:",t),{ok:!1,error:t instanceof Error?t.message:"Network request failed"}}}async function H(){var t;const r=await v("/workspaces");if(r.ok&&((t=r.data)!=null&&t.workspaces)){const n=r.data.workspaces.find(i=>i.isDefault)||r.data.workspaces[0];return n?(await G(n),{ok:!0,data:n}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:r.error||"Failed to fetch workspaces"}}async function R(){const r=await D();if(r)return r.id;const t=await H();return t.ok&&t.data?t.data.id:null}async function Z(){const r=await v("/workspaces");return r.ok?{ok:!0}:{ok:!1,error:r.error}}async function E(r){const t=await R();if(!t)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const{meta:n,...i}=r;return J("/cards",{...i,workspaceId:t,type:"url",source:{type:"webext"},image:n==null?void 0:n.ogImage,description:n==null?void 0:n.description,favicon:n==null?void 0:n.favicon})}async function z(){var n;const r=await R();if(!r)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const t=await v(`/collections?workspaceId=${r}`);return t.ok&&((n=t.data)!=null&&n.collections)?{ok:!0,data:t.data.collections.map(g=>({id:g.id,name:g.name,emoji:g.icon||null,slug:g.slug||g.id}))}:{ok:!1,error:t.error||"Failed to fetch collections"}}A.runtime.onInstalled.addListener(()=>{A.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),A.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("Pawkit Web Clipper installed")}),A.contextMenus.onClicked.addListener(async(r,t)=>{if(t!=null&&t.id)try{if(r.menuItemId==="save-to-pawkit"){const n=(r.linkUrl||r.pageUrl||t.url)??"",i=r.linkUrl?new URL(r.linkUrl).hostname:t.title||"Untitled",g=await E({title:i,url:n,source:"webext"});L(g,i)}else if(r.menuItemId==="save-image-to-pawkit"&&r.srcUrl){const n=t.url||"",i=r.srcUrl,g=t.title||"Untitled",m=await E({title:g,url:n,source:"webext",notes:`Image URL: ${i}`,meta:{ogImage:i}});L(m,g)}}catch(n){console.error("Context menu save failed:",n)}});function L(r,t){var n,i;r.ok?(n=A.notifications)==null||n.create({type:"basic",iconUrl:A.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${t}" has been saved to your Pawkit`}):(i=A.notifications)==null||i.create({type:"basic",iconUrl:A.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:r.error||"Failed to save to Pawkit"})}A.runtime.onMessage.addListener((r,t)=>{var n,i;if(r.type==="REOPEN_POPUP"){(n=A.action)!=null&&n.openPopup?A.action.openPopup().catch(()=>{var g;(g=A.notifications)==null||g.create({type:"basic",iconUrl:A.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(i=A.notifications)==null||i.create({type:"basic",iconUrl:A.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return new Promise(async g=>{try{switch(r.type){case"SAVE_CARD":{const m=await E(r.payload);g(m);break}case"CHECK_AUTH":{const m=await Z();g(m);break}case"GET_COLLECTIONS":{const m=await z();g(m);break}default:g({ok:!1,error:"Unknown message type"})}}catch(m){console.error("Message handler error:",m),g({ok:!1,error:m instanceof Error?m.message:"Unknown error"})}})}),console.log("Pawkit service worker running")})();

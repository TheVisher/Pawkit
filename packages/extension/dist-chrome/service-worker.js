(function(){"use strict";var z=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function J(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var O={exports:{}};(function(e,t){(function(n,g){g(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:z,function(n){var g,o;if(!((o=(g=globalThis.chrome)==null?void 0:g.runtime)!=null&&o.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const c="The message port closed before a response was received.",b=f=>{const u={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(u).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class I extends WeakMap{constructor(s,i=void 0){super(i),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const N=r=>r&&typeof r=="object"&&typeof r.then=="function",y=(r,s)=>(...i)=>{f.runtime.lastError?r.reject(new Error(f.runtime.lastError.message)):s.singleCallbackArg||i.length<=1&&s.singleCallbackArg!==!1?r.resolve(i[0]):r.resolve(i)},h=r=>r==1?"argument":"arguments",ne=(r,s)=>function(l,...d){if(d.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${d.length}`);if(d.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${d.length}`);return new Promise((x,w)=>{if(s.fallbackToNoCallback)try{l[r](...d,y({resolve:x,reject:w},s))}catch(a){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),l[r](...d),s.fallbackToNoCallback=!1,s.noCallback=!0,x()}else s.noCallback?(l[r](...d),x()):l[r](...d,y({resolve:x,reject:w},s))})},q=(r,s,i)=>new Proxy(s,{apply(l,d,x){return i.call(d,r,...x)}});let C=Function.call.bind(Object.prototype.hasOwnProperty);const E=(r,s={},i={})=>{let l=Object.create(null),d={has(w,a){return a in r||a in l},get(w,a,k){if(a in l)return l[a];if(!(a in r))return;let A=r[a];if(typeof A=="function")if(typeof s[a]=="function")A=q(r,r[a],s[a]);else if(C(i,a)){let P=ne(a,i[a]);A=q(r,r[a],P)}else A=A.bind(r);else if(typeof A=="object"&&A!==null&&(C(s,a)||C(i,a)))A=E(A,s[a],i[a]);else if(C(i,"*"))A=E(A,s[a],i["*"]);else return Object.defineProperty(l,a,{configurable:!0,enumerable:!0,get(){return r[a]},set(P){r[a]=P}}),A;return l[a]=A,A},set(w,a,k,A){return a in l?l[a]=k:r[a]=k,!0},defineProperty(w,a,k){return Reflect.defineProperty(l,a,k)},deleteProperty(w,a){return Reflect.deleteProperty(l,a)}},x=Object.create(r);return new Proxy(x,d)},R=r=>({addListener(s,i,...l){s.addListener(r.get(i),...l)},hasListener(s,i){return s.hasListener(r.get(i))},removeListener(s,i){s.removeListener(r.get(i))}}),oe=new I(r=>typeof r!="function"?r:function(i){const l=E(i,{},{getContent:{minArgs:0,maxArgs:0}});r(l)}),G=new I(r=>typeof r!="function"?r:function(i,l,d){let x=!1,w,a=new Promise(S=>{w=function(p){x=!0,S(p)}}),k;try{k=r(i,l,w)}catch(S){k=Promise.reject(S)}const A=k!==!0&&N(k);if(k!==!0&&!A&&!x)return!1;const P=S=>{S.then(p=>{d(p)},p=>{let U;p&&(p instanceof Error||typeof p.message=="string")?U=p.message:U="An unexpected error occurred",d({__mozWebExtensionPolyfillReject__:!0,message:U})}).catch(p=>{console.error("Failed to send onMessage rejected reply",p)})};return P(A?k:a),!0}),ae=({reject:r,resolve:s},i)=>{f.runtime.lastError?f.runtime.lastError.message===c?s():r(new Error(f.runtime.lastError.message)):i&&i.__mozWebExtensionPolyfillReject__?r(new Error(i.message)):s(i)},H=(r,s,i,...l)=>{if(l.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${l.length}`);if(l.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${l.length}`);return new Promise((d,x)=>{const w=ae.bind(null,{resolve:d,reject:x});l.push(w),i.sendMessage(...l)})},ie={devtools:{network:{onRequestFinished:R(oe)}},runtime:{onMessage:R(G),onMessageExternal:R(G),sendMessage:H.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:H.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},M={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return u.privacy={network:{"*":M},services:{"*":M},websites:{"*":M}},E(f,ie,u)};n.exports=b(chrome)}else n.exports=globalThis.browser})})(O);var V=O.exports;const m=J(V),L="https://www.getpawkit.com/api",Z=5*60;async function F(){try{return(await m.storage.local.get("pawkit_session")).pawkit_session||null}catch(e){return console.error("[API] Failed to get stored session:",e),null}}async function $(e){await m.storage.local.set({pawkit_session:e}),console.log("[API] Session stored, expires at:",new Date(e.expires_at*1e3).toISOString())}async function T(){await m.storage.local.remove(["pawkit_session","pawkit_workspace"]),console.log("[API] Session cleared")}function j(e){const t=Math.floor(Date.now()/1e3);return e.expires_at-t<Z}async function W(e){try{console.log("[API] Refreshing access token...");const t=await fetch(`${L}/auth/extension`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)return console.error("[API] Token refresh failed:",t.status),null;const n=await t.json();if(!n.authenticated||!n.session)return console.error("[API] Token refresh returned invalid data"),null;const g={access_token:n.session.access_token,refresh_token:n.session.refresh_token,expires_at:n.session.expires_at,user:n.session.user};return await $(g),console.log("[API] Token refreshed successfully"),g}catch(t){return console.error("[API] Token refresh error:",t),null}}async function K(){const e=await F();if(!e)return null;if(j(e)){const t=await W(e.refresh_token);return t?t.access_token:(await T(),null)}return e.access_token}async function v(e,t,n,g=15e3){const o=await K();if(!o)return{ok:!1,error:"Not logged in. Click the extension icon and log in first."};try{const c=new AbortController,b=setTimeout(()=>c.abort(),g),f={method:e,headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},signal:c.signal};n&&(e==="POST"||e==="PATCH")&&(f.body=JSON.stringify(n));const u=await fetch(`${L}${t}`,f);if(clearTimeout(b),u.status===401)return await T(),{ok:!1,error:"Session expired. Please log in again."};if(!u.ok){const N=await u.text();let y=`API error: ${u.status}`;try{const h=JSON.parse(N);y=h.message||h.error||y}catch{}return{ok:!1,error:y}}return{ok:!0,data:await u.json()}}catch(c){return c instanceof Error&&c.name==="AbortError"?{ok:!1,error:"Request timed out. Please try again."}:(console.error("[API] Request failed:",c),{ok:!1,error:c instanceof Error?c.message:"Network request failed"})}}async function Y(){try{return(await m.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(e){return console.error("[API] Failed to get workspace:",e),null}}async function Q(e){await m.storage.local.set({pawkit_workspace:e})}async function X(){var t;const e=await v("GET","/workspaces");if(e.ok&&((t=e.data)!=null&&t.workspaces)){const n=e.data.workspaces.find(g=>g.isDefault)||e.data.workspaces[0];return n?(await Q(n),{ok:!0,data:n}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:e.error||"Failed to fetch workspaces"}}async function B(){const e=await Y();if(e)return e.id;const t=await X();return t.ok&&t.data?t.data.id:null}async function ee(){const e=await F();if(!e)return{ok:!1,error:"Not logged in"};if(j(e)){const t=await W(e.refresh_token);return t?{ok:!0,user:{email:t.user.email}}:(await T(),{ok:!1,error:"Session expired"})}return{ok:!0,user:{email:e.user.email}}}async function re(){const e=await m.tabs.query({url:["https://getpawkit.com/*","https://www.getpawkit.com/*"]});e.length>0&&e[0].id?(await m.tabs.update(e[0].id,{active:!0}),e[0].windowId&&await m.windows.update(e[0].windowId,{focused:!0})):await m.tabs.create({url:"https://www.getpawkit.com/login"})}async function se(e){return v("POST","/metadata",{url:e},5e3)}async function _(e){const t=await B();if(!t)return{ok:!1,error:"Not logged in. Please log in to Pawkit first."};const{meta:n,...g}=e;let o=n==null?void 0:n.ogImage,c=n==null?void 0:n.description,b=n==null?void 0:n.favicon,f=null;if(!o&&e.url)try{console.log("[API] Fetching metadata for:",e.url);const u=await se(e.url);u.ok&&u.data&&(o=u.data.image||void 0,c=u.data.description||void 0,b=u.data.favicon||void 0,f=u.data.title,console.log("[API] Metadata fetched:",{image:!!o,description:!!c}))}catch{console.log("[API] Metadata fetch failed, saving without thumbnail")}return v("POST","/cards",{...g,title:g.title===e.url&&f?f:g.title,workspaceId:t,type:"url",status:o?"READY":"PENDING",source:{type:"webext"},image:o,description:c,favicon:b})}async function te(){var n;const e=await B();if(!e)return{ok:!1,error:"Not logged in. Please log in to Pawkit first."};const t=await v("GET",`/collections?workspaceId=${e}`);return t.ok&&((n=t.data)!=null&&n.collections)?{ok:!0,data:t.data.collections.map(o=>({id:o.id,name:o.name,emoji:o.icon||null,slug:o.slug||o.id}))}:{ok:!1,error:t.error||"Failed to fetch collections"}}m.runtime.onInstalled.addListener(()=>{m.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),m.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("[Service Worker] Pawkit Web Clipper installed")}),m.contextMenus.onClicked.addListener(async(e,t)=>{if(t!=null&&t.id)try{if(e.menuItemId==="save-to-pawkit"){const n=(e.linkUrl||e.pageUrl||t.url)??"",g=e.linkUrl?new URL(e.linkUrl).hostname:t.title||"Untitled",o=await _({title:g,url:n,source:"webext"});D(o,g)}else if(e.menuItemId==="save-image-to-pawkit"&&e.srcUrl){const n=t.url||"",g=e.srcUrl,o=t.title||"Untitled",c=await _({title:o,url:n,source:"webext",notes:`Image URL: ${g}`,meta:{ogImage:g}});D(c,o)}}catch(n){console.error("[Service Worker] Context menu save failed:",n)}});function D(e,t){var n,g;e.ok?(n=m.notifications)==null||n.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${t}" has been saved to your Pawkit`}):(g=m.notifications)==null||g.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:e.error||"Failed to save to Pawkit"})}m.runtime.onMessage.addListener((e,t)=>{var n,g;if(e.type==="SESSION_UPDATE"){const o=e;return o.authenticated&&o.session?$(o.session).then(()=>(console.log("[Service Worker] Session stored from content script"),{ok:!0})):T().then(()=>(console.log("[Service Worker] Session cleared (user logged out)"),{ok:!0}))}if(e.type==="REOPEN_POPUP"){(n=m.action)!=null&&n.openPopup?m.action.openPopup().catch(()=>{var o;(o=m.notifications)==null||o.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(g=m.notifications)==null||g.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return e.type==="INITIATE_LOGIN"?re().then(()=>({ok:!0})):e.type==="LOGOUT"?T().then(()=>({ok:!0})):new Promise(async o=>{try{switch(e.type){case"SAVE_CARD":{const c=await _(e.payload);o(c);break}case"CHECK_AUTH":{const c=await ee();o(c);break}case"GET_COLLECTIONS":{const c=await te();o(c);break}default:o({ok:!1,error:"Unknown message type"})}}catch(c){console.error("[Service Worker] Message handler error:",c),o({ok:!1,error:c instanceof Error?c.message:"Unknown error"})}})}),console.log("[Service Worker] Pawkit service worker running")})();

(function(){"use strict";var j=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function W(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var M={exports:{}};(function(e,i){(function(n,l){l(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:j,function(n){var l,g;if(!((g=(l=globalThis.chrome)==null?void 0:l.runtime)!=null&&g.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const u="The message port closed before a response was received.",K=p=>{const T={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(T).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class N extends WeakMap{constructor(s,a=void 0){super(a),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const Q=r=>r&&typeof r=="object"&&typeof r.then=="function",_=(r,s)=>(...a)=>{p.runtime.lastError?r.reject(new Error(p.runtime.lastError.message)):s.singleCallbackArg||a.length<=1&&s.singleCallbackArg!==!1?r.resolve(a[0]):r.resolve(a)},h=r=>r==1?"argument":"arguments",J=(r,s)=>function(o,...A){if(A.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${A.length}`);if(A.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${A.length}`);return new Promise((d,x)=>{if(s.fallbackToNoCallback)try{o[r](...A,_({resolve:d,reject:x},s))}catch(t){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,t),o[r](...A),s.fallbackToNoCallback=!1,s.noCallback=!0,d()}else s.noCallback?(o[r](...A),d()):o[r](...A,_({resolve:d,reject:x},s))})},I=(r,s,a)=>new Proxy(s,{apply(o,A,d){return a.call(A,r,...d)}});let y=Function.call.bind(Object.prototype.hasOwnProperty);const P=(r,s={},a={})=>{let o=Object.create(null),A={has(x,t){return t in r||t in o},get(x,t,f){if(t in o)return o[t];if(!(t in r))return;let c=r[t];if(typeof c=="function")if(typeof s[t]=="function")c=I(r,r[t],s[t]);else if(y(a,t)){let k=J(t,a[t]);c=I(r,r[t],k)}else c=c.bind(r);else if(typeof c=="object"&&c!==null&&(y(s,t)||y(a,t)))c=P(c,s[t],a[t]);else if(y(a,"*"))c=P(c,s[t],a["*"]);else return Object.defineProperty(o,t,{configurable:!0,enumerable:!0,get(){return r[t]},set(k){r[t]=k}}),c;return o[t]=c,c},set(x,t,f,c){return t in o?o[t]=f:r[t]=f,!0},defineProperty(x,t,f){return Reflect.defineProperty(o,t,f)},deleteProperty(x,t){return Reflect.deleteProperty(o,t)}},d=Object.create(r);return new Proxy(d,A)},E=r=>({addListener(s,a,...o){s.addListener(r.get(a),...o)},hasListener(s,a){return s.hasListener(r.get(a))},removeListener(s,a){s.removeListener(r.get(a))}}),X=new N(r=>typeof r!="function"?r:function(a){const o=P(a,{},{getContent:{minArgs:0,maxArgs:0}});r(o)}),O=new N(r=>typeof r!="function"?r:function(a,o,A){let d=!1,x,t=new Promise(b=>{x=function(w){d=!0,b(w)}}),f;try{f=r(a,o,x)}catch(b){f=Promise.reject(b)}const c=f!==!0&&Q(f);if(f!==!0&&!c&&!d)return!1;const k=b=>{b.then(w=>{A(w)},w=>{let U;w&&(w instanceof Error||typeof w.message=="string")?U=w.message:U="An unexpected error occurred",A({__mozWebExtensionPolyfillReject__:!0,message:U})}).catch(w=>{console.error("Failed to send onMessage rejected reply",w)})};return k(c?f:t),!0}),Y=({reject:r,resolve:s},a)=>{p.runtime.lastError?p.runtime.lastError.message===u?s():r(new Error(p.runtime.lastError.message)):a&&a.__mozWebExtensionPolyfillReject__?r(new Error(a.message)):s(a)},$=(r,s,a,...o)=>{if(o.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${o.length}`);if(o.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${o.length}`);return new Promise((A,d)=>{const x=Y.bind(null,{resolve:A,reject:d});o.push(x),a.sendMessage(...o)})},ee={devtools:{network:{onRequestFinished:E(X)}},runtime:{onMessage:E(O),onMessageExternal:E(O),sendMessage:$.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:$.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},S={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return T.privacy={network:{"*":S},services:{"*":S},websites:{"*":S}},P(p,ee,T)};n.exports=K(chrome)}else n.exports=globalThis.browser})})(M);var B=M.exports;const m=W(B);async function q(){try{const e=await m.tabs.query({url:["https://getpawkit.com/*","https://www.getpawkit.com/*"]});return e.length>0&&e[0].id?e[0].id:null}catch(e){return console.error("Failed to find Pawkit tab:",e),null}}async function R(e,i,n){const l=await q();if(!l)return{ok:!1,error:"Please open getpawkit.com in a tab and log in first."};try{return await m.tabs.sendMessage(l,{type:"API_REQUEST",method:e,path:i,body:n})}catch(g){return console.error("Bridge request failed:",g),{ok:!1,error:"Failed to communicate with Pawkit tab. Please refresh getpawkit.com and try again."}}}async function D(){try{return(await m.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(e){return console.error("Failed to get workspace:",e),null}}async function G(e){await m.storage.local.set({pawkit_workspace:e})}async function H(e,i,n=!1){return n?{ok:!1,error:"Form uploads not supported"}:R("POST",e,i)}async function C(e){return R("GET",e)}async function V(){var i;const e=await C("/workspaces");if(e.ok&&((i=e.data)!=null&&i.workspaces)){const n=e.data.workspaces.find(l=>l.isDefault)||e.data.workspaces[0];return n?(await G(n),{ok:!0,data:n}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:e.error||"Failed to fetch workspaces"}}async function L(){const e=await D();if(e)return e.id;const i=await V();return i.ok&&i.data?i.data.id:null}async function Z(){const e=await C("/workspaces");return e.ok?{ok:!0}:{ok:!1,error:e.error}}async function v(e){const i=await L();if(!i)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const{meta:n,...l}=e;return H("/cards",{...l,workspaceId:i,type:"url",source:{type:"webext"},image:n==null?void 0:n.ogImage,description:n==null?void 0:n.description,favicon:n==null?void 0:n.favicon})}async function z(){var n;const e=await L();if(!e)return{ok:!1,error:"Not logged in. Please log in to Pawkit in your browser first."};const i=await C(`/collections?workspaceId=${e}`);return i.ok&&((n=i.data)!=null&&n.collections)?{ok:!0,data:i.data.collections.map(g=>({id:g.id,name:g.name,emoji:g.icon||null,slug:g.slug||g.id}))}:{ok:!1,error:i.error||"Failed to fetch collections"}}m.runtime.onInstalled.addListener(()=>{m.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),m.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("Pawkit Web Clipper installed")}),m.contextMenus.onClicked.addListener(async(e,i)=>{if(i!=null&&i.id)try{if(e.menuItemId==="save-to-pawkit"){const n=(e.linkUrl||e.pageUrl||i.url)??"",l=e.linkUrl?new URL(e.linkUrl).hostname:i.title||"Untitled",g=await v({title:l,url:n,source:"webext"});F(g,l)}else if(e.menuItemId==="save-image-to-pawkit"&&e.srcUrl){const n=i.url||"",l=e.srcUrl,g=i.title||"Untitled",u=await v({title:g,url:n,source:"webext",notes:`Image URL: ${l}`,meta:{ogImage:l}});F(u,g)}}catch(n){console.error("Context menu save failed:",n)}});function F(e,i){var n,l;e.ok?(n=m.notifications)==null||n.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${i}" has been saved to your Pawkit`}):(l=m.notifications)==null||l.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:e.error||"Failed to save to Pawkit"})}m.runtime.onMessage.addListener((e,i)=>{var n,l;if(e.type==="REOPEN_POPUP"){(n=m.action)!=null&&n.openPopup?m.action.openPopup().catch(()=>{var g;(g=m.notifications)==null||g.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(l=m.notifications)==null||l.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return new Promise(async g=>{try{switch(e.type){case"SAVE_CARD":{const u=await v(e.payload);g(u);break}case"CHECK_AUTH":{const u=await Z();g(u);break}case"GET_COLLECTIONS":{const u=await z();g(u);break}default:g({ok:!1,error:"Unknown message type"})}}catch(u){console.error("Message handler error:",u),g({ok:!1,error:u instanceof Error?u.message:"Unknown error"})}})}),console.log("Pawkit service worker running")})();

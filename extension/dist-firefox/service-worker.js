(function(){"use strict";var G=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function H(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var R={exports:{}};(function(e,n){(function(t,g){g(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:G,function(t){var g,a;if(!((a=(g=globalThis.chrome)==null?void 0:g.runtime)!=null&&a.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const c="The message port closed before a response was received.",b=f=>{const u={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(u).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class N extends WeakMap{constructor(s,i=void 0){super(i),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const M=r=>r&&typeof r=="object"&&typeof r.then=="function",y=(r,s)=>(...i)=>{f.runtime.lastError?r.reject(new Error(f.runtime.lastError.message)):s.singleCallbackArg||i.length<=1&&s.singleCallbackArg!==!1?r.resolve(i[0]):r.resolve(i)},h=r=>r==1?"argument":"arguments",se=(r,s)=>function(l,...d){if(d.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${d.length}`);if(d.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${d.length}`);return new Promise((x,k)=>{if(s.fallbackToNoCallback)try{l[r](...d,y({resolve:x,reject:k},s))}catch(o){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,o),l[r](...d),s.fallbackToNoCallback=!1,s.noCallback=!0,x()}else s.noCallback?(l[r](...d),x()):l[r](...d,y({resolve:x,reject:k},s))})},B=(r,s,i)=>new Proxy(s,{apply(l,d,x){return i.call(d,r,...x)}});let C=Function.call.bind(Object.prototype.hasOwnProperty);const E=(r,s={},i={})=>{let l=Object.create(null),d={has(k,o){return o in r||o in l},get(k,o,w){if(o in l)return l[o];if(!(o in r))return;let A=r[o];if(typeof A=="function")if(typeof s[o]=="function")A=B(r,r[o],s[o]);else if(C(i,o)){let v=se(o,i[o]);A=B(r,r[o],v)}else A=A.bind(r);else if(typeof A=="object"&&A!==null&&(C(s,o)||C(i,o)))A=E(A,s[o],i[o]);else if(C(i,"*"))A=E(A,s[o],i["*"]);else return Object.defineProperty(l,o,{configurable:!0,enumerable:!0,get(){return r[o]},set(v){r[o]=v}}),A;return l[o]=A,A},set(k,o,w,A){return o in l?l[o]=w:r[o]=w,!0},defineProperty(k,o,w){return Reflect.defineProperty(l,o,w)},deleteProperty(k,o){return Reflect.deleteProperty(l,o)}},x=Object.create(r);return new Proxy(x,d)},U=r=>({addListener(s,i,...l){s.addListener(r.get(i),...l)},hasListener(s,i){return s.hasListener(r.get(i))},removeListener(s,i){s.removeListener(r.get(i))}}),te=new N(r=>typeof r!="function"?r:function(i){const l=E(i,{},{getContent:{minArgs:0,maxArgs:0}});r(l)}),q=new N(r=>typeof r!="function"?r:function(i,l,d){let x=!1,k,o=new Promise(P=>{k=function(p){x=!0,P(p)}}),w;try{w=r(i,l,k)}catch(P){w=Promise.reject(P)}const A=w!==!0&&M(w);if(w!==!0&&!A&&!x)return!1;const v=P=>{P.then(p=>{d(p)},p=>{let _;p&&(p instanceof Error||typeof p.message=="string")?_=p.message:_="An unexpected error occurred",d({__mozWebExtensionPolyfillReject__:!0,message:_})}).catch(p=>{console.error("Failed to send onMessage rejected reply",p)})};return v(A?w:o),!0}),ne=({reject:r,resolve:s},i)=>{f.runtime.lastError?f.runtime.lastError.message===c?s():r(new Error(f.runtime.lastError.message)):i&&i.__mozWebExtensionPolyfillReject__?r(new Error(i.message)):s(i)},D=(r,s,i,...l)=>{if(l.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${h(s.minArgs)} for ${r}(), got ${l.length}`);if(l.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${h(s.maxArgs)} for ${r}(), got ${l.length}`);return new Promise((d,x)=>{const k=ne.bind(null,{resolve:d,reject:x});l.push(k),i.sendMessage(...l)})},ae={devtools:{network:{onRequestFinished:U(te)}},runtime:{onMessage:U(q),onMessageExternal:U(q),sendMessage:D.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:D.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},O={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return u.privacy={network:{"*":O},services:{"*":O},websites:{"*":O}},E(f,ae,u)};t.exports=b(chrome)}else t.exports=globalThis.browser})})(R);var z=R.exports;const m=H(z),L="https://beloved-spaniel-215.convex.site/api";async function F(){try{return(await m.storage.local.get("pawkit_session")).pawkit_session||null}catch(e){return console.error("[API] Failed to get stored session:",e),null}}async function J(e){await m.storage.local.set({pawkit_session:e}),console.log("[API] Session stored for user:",e.user.email)}async function S(){await m.storage.local.remove(["pawkit_session","pawkit_workspace"]),console.log("[API] Session cleared")}async function V(){const e=await F();return(e==null?void 0:e.token)||null}async function T(e,n,t,g=15e3){const a=await V();if(!a)return{ok:!1,error:"Not logged in. Click the extension icon and enter your extension token."};try{const c=new AbortController,b=setTimeout(()=>c.abort(),g),f={method:e,headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},signal:c.signal};t&&(e==="POST"||e==="PATCH")&&(f.body=JSON.stringify(t));const u=await fetch(`${L}${n}`,f);if(clearTimeout(b),u.status===401)return await S(),{ok:!1,error:"Extension token is invalid. Please enter a new token."};if(!u.ok){const M=await u.text();let y=`API error: ${u.status}`;try{const h=JSON.parse(M);y=h.message||h.error||y}catch{}return{ok:!1,error:y}}return{ok:!0,data:await u.json()}}catch(c){return c instanceof Error&&c.name==="AbortError"?{ok:!1,error:"Request timed out. Please try again."}:(console.error("[API] Request failed:",c),{ok:!1,error:c instanceof Error?c.message:"Network request failed"})}}async function Z(){try{return(await m.storage.local.get("pawkit_workspace")).pawkit_workspace||null}catch(e){return console.error("[API] Failed to get workspace:",e),null}}async function K(e){await m.storage.local.set({pawkit_workspace:e})}async function $(){var n;const e=await T("GET","/workspaces");if(e.ok&&((n=e.data)!=null&&n.workspaces)){const t=e.data.workspaces.find(g=>g.isDefault)||e.data.workspaces[0];return t?(await K(t),{ok:!0,data:t}):{ok:!1,error:"No workspaces found"}}return{ok:!1,error:e.error||"Failed to fetch workspaces"}}async function j(){const e=await Z();if(e)return e.id;const n=await $();return n.ok&&n.data?n.data.id:null}async function Q(e){try{const n=await fetch(`${L}/auth/extension`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!n.ok)return{ok:!1,error:"Failed to validate token"};const t=await n.json();return!t.authenticated||!t.user?{ok:!1,error:"Invalid extension token"}:(await J({token:e,user:{id:t.user.id,email:t.user.email}}),await $(),{ok:!0})}catch(n){return console.error("[API] Token validation error:",n),{ok:!1,error:n instanceof Error?n.message:"Token validation failed"}}}async function X(){var t,g;const e=await F();if(!e)return{ok:!1,error:"Not logged in"};const n=await T("GET","/workspaces");return n.ok?{ok:!0,user:{email:e.user.email}}:(t=n.error)!=null&&t.includes("401")||(g=n.error)!=null&&g.includes("invalid")?(await S(),{ok:!1,error:"Extension token is invalid"}):{ok:!0,user:{email:e.user.email}}}async function Y(){await m.tabs.create({url:"https://www.getpawkit.com/extension/connect"})}async function ee(e){return T("POST","/metadata",{url:e},5e3)}async function I(e){const n=await j();if(!n)return{ok:!1,error:"Not logged in. Please enter your extension token first."};const{meta:t,...g}=e;let a=t==null?void 0:t.ogImage,c=t==null?void 0:t.description,b=t==null?void 0:t.favicon,f=null;if(!a&&e.url)try{console.log("[API] Fetching metadata for:",e.url);const u=await ee(e.url);u.ok&&u.data&&(a=u.data.image||void 0,c=u.data.description||void 0,b=u.data.favicon||void 0,f=u.data.title,console.log("[API] Metadata fetched:",{image:!!a,description:!!c}))}catch{console.log("[API] Metadata fetch failed, saving without thumbnail")}return T("POST","/cards",{...g,title:g.title===e.url&&f?f:g.title,workspaceId:n,type:"url",image:a,description:c,favicon:b})}async function re(){var t;const e=await j();if(!e)return{ok:!1,error:"Not logged in. Please enter your extension token first."};const n=await T("GET",`/collections?workspaceId=${e}`);return n.ok&&((t=n.data)!=null&&t.collections)?{ok:!0,data:n.data.collections.filter(a=>typeof a.slug=="string"&&a.slug.trim()!=="").map(a=>({id:a.id,name:a.name,emoji:a.icon||null,slug:a.slug}))}:{ok:!1,error:n.error||"Failed to fetch collections"}}m.runtime.onInstalled.addListener(()=>{m.contextMenus.create({id:"save-to-pawkit",title:"Save page to Pawkit",contexts:["page","link"]}),m.contextMenus.create({id:"save-image-to-pawkit",title:"Save image to Pawkit",contexts:["image"]}),console.log("[Service Worker] Pawkit Web Clipper installed")}),m.contextMenus.onClicked.addListener(async(e,n)=>{if(n!=null&&n.id)try{if(e.menuItemId==="save-to-pawkit"){const t=(e.linkUrl||e.pageUrl||n.url)??"",g=e.linkUrl?new URL(e.linkUrl).hostname:n.title||"Untitled",a=await I({title:g,url:t,source:"webext"});W(a,g)}else if(e.menuItemId==="save-image-to-pawkit"&&e.srcUrl){const t=n.url||"",g=e.srcUrl,a=n.title||"Untitled",c=await I({title:a,url:t,source:"webext",notes:`Image URL: ${g}`,meta:{ogImage:g}});W(c,a)}}catch(t){console.error("[Service Worker] Context menu save failed:",t)}});function W(e,n){var t,g;e.ok?(t=m.notifications)==null||t.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Saved to Pawkit",message:`"${n}" has been saved to your Pawkit`}):(g=m.notifications)==null||g.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Save Failed",message:e.error||"Failed to save to Pawkit"})}m.runtime.onMessage.addListener((e,n)=>{var t,g;if(e.type==="VALIDATE_TOKEN"&&e.token)return Q(e.token).then(a=>(console.log("[Service Worker] Token validation result:",a.ok),a));if(e.type==="REOPEN_POPUP"){(t=m.action)!=null&&t.openPopup?m.action.openPopup().catch(()=>{var a;(a=m.notifications)==null||a.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"})}):(g=m.notifications)==null||g.create({type:"basic",iconUrl:m.runtime.getURL("icons/icon-48.png"),title:"Thumbnail Selected",message:"Click the Pawkit icon to save with your selected thumbnail"});return}return e.type==="INITIATE_LOGIN"?Y().then(()=>({ok:!0})):e.type==="LOGOUT"?S().then(()=>({ok:!0})):new Promise(async a=>{try{switch(e.type){case"SAVE_CARD":{const c=await I(e.payload);a(c);break}case"CHECK_AUTH":{const c=await X();a(c);break}case"GET_COLLECTIONS":{const c=await re();a(c);break}default:a({ok:!1,error:"Unknown message type"})}}catch(c){console.error("[Service Worker] Message handler error:",c),a({ok:!1,error:c instanceof Error?c.message:"Unknown error"})}})}),console.log("[Service Worker] Pawkit service worker running")})();

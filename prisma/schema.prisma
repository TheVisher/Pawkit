// Pawkit V2 Prisma Schema - FINAL
// Stage 1: Core entities (User, Workspace, UserViewSettings)
// Stage 2: Content entities (Card, Collection, CollectionNote)
// Stage 3: Organization entities (CalendarEvent, Todo)
// Stage 4: Future-ready entities (Connection, ConnectedAccount, ImportJob, Citation, QuickNoteArchive)

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector] // For future AI embeddings
}

// =============================================================================
// STAGE 1: CORE ENTITIES
// =============================================================================

/// User - Authenticated user from Supabase Auth
/// Note: id comes from Supabase Auth, not generated by Prisma
model User {
  id          String  @id // Supabase Auth UUID
  email       String  @unique
  displayName String?

  // Extension authentication (V1 parity)
  extensionToken          String?   @unique
  extensionTokenCreatedAt DateTime?

  // Local-only mode toggle (V1 parity)
  // When false, user data stays local and doesn't sync to server
  serverSync Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspaces        Workspace[]
  connectedAccounts ConnectedAccount[]
  connections       Connection[]

  @@index([email])
}

/// Workspace - Isolated data container for user content
/// Users can have multiple workspaces (personal, work, etc.)
model Workspace {
  id        String  @id @default(cuid())
  name      String
  icon      String? // Emoji or icon identifier
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  isDefault Boolean @default(false)

  // User preferences synced across devices
  // Example: { recentTags: ["work", "important", "todo"] }
  preferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  viewSettings   UserViewSettings[]
  cards          Card[]
  collections    Collection[]
  calendarEvents CalendarEvent[]
  todos          Todo[]
  references     Reference[]

  @@index([userId])
}

/// UserViewSettings - Per-view layout preferences (synced across devices)
/// Stores layout/sort preferences for each view+contentType combination
model UserViewSettings {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // View identifier examples:
  // - "library" (all content)
  // - "library:notes" (filtered to notes)
  // - "library:bookmarks" (filtered to bookmarks)
  // - "pawkit:{slug}" (specific collection)
  // - "calendar" (calendar view)
  viewKey String

  // Layout settings (all synced)
  layout      String  @default("grid") // grid, masonry, list, timeline, board
  sortBy      String  @default("createdAt")
  sortOrder   String  @default("desc") // asc, desc
  showTitles  Boolean @default(true)
  showUrls    Boolean @default(true)
  showTags    Boolean @default(true)
  cardPadding Int     @default(2) // 0-4 scale

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, viewKey])
  @@index([workspaceId])
}

// =============================================================================
// STAGE 2: CONTENT ENTITIES
// =============================================================================

/// Card - The core content unit (bookmarks, notes, files)
/// Supports URL bookmarks, markdown notes, text notes, quick notes, and files
/// Notes are organized via Pawkits (Collections) + Tags, NOT separate folders
model Card {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Content type and primary data
  type        String  @default("url") // url, md-note, text-note, quick-note, file
  url         String // URL for bookmarks, empty string "" for notes
  title       String?
  description String?
  content     String? // Note content or extracted article text

  // User annotations (separate from content - V1 parity)
  notes String? // User's personal notes/annotations

  // Metadata from scraping
  domain   String?
  image    String? // Thumbnail/preview image URL
  favicon  String?
  metadata Json? // Flexible metadata from scraping (OpenGraph, etc.)

  // Async metadata fetch status (V1 parity)
  status String @default("PENDING") // PENDING, READY, ERROR

  // YouTube transcripts for Kit AI context (V1 parity)
  transcriptSegments String? // JSON array of transcript segments

  // AI & Future Features
  embedding      Unsupported("vector(1536)")? // pgvector for similarity search
  structuredData Json? // Kit-extracted rich data (dates, ingredients, etc.)
  source         Json? // { type: 'manual' | 'extension' | 'kit' | 'reddit' | 'youtube', ... }

  // Organization - ALL via tags now
  // Pawkit membership, user tags, date tags (#2026-01-30), supertags (#contact)
  // See: .claude/skills/pawkit-tag-architecture/SKILL.md
  tags        String[] // Includes Pawkit slugs + user tags + date tags + supertags
  collections String[] // DEPRECATED - kept for migration, will be removed. Use tags instead.
  pinned      Boolean  @default(false)

  // Scheduling (for calendar integration)
  /// @deprecated Use scheduledDates[] instead - will be removed after migration
  scheduledDate      DateTime?
  scheduledDates     String[] @default([]) // Array of ISO date strings (YYYY-MM-DD) for multi-date calendar
  scheduledStartTime String? // HH:mm format
  scheduledEndTime   String? // HH:mm format

  // Article/Reader mode
  articleContent String? // Cleaned article HTML
  summary        String? // AI-generated summary
  summaryType    String? // concise, detailed

  // Soft delete
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // File support
  isFileCard Boolean @default(false)
  fileId     String? // Reference to file in local IndexedDB

  // Cloud sync
  cloudId         String?
  cloudProvider   String?
  cloudSyncedAt   DateTime?

  // Smart Detection
  convertedToTodo         Boolean   @default(false)
  dismissedTodoSuggestion Boolean   @default(false)

  // Reading Tracking
  wordCount          Int?     // Word count of article content
  readingTime        Int?     // Estimated minutes (wordCount / 225 WPM)
  readProgress       Int?     // 0-100 scroll percentage
  isRead             Boolean  @default(false)
  lastScrollPosition Int?     // Pixel position for resume reading

  // Link Health
  linkStatus    String?   // 'ok' | 'broken' | 'redirect' | 'unchecked'
  lastLinkCheck DateTime?
  redirectUrl   String?   // Final URL if redirected

  // Daily Note
  isDailyNote Boolean @default(false)

  // Sync conflict tracking
  version        Int     @default(1) // Incremented on each server update
  conflictWithId String? // Links to conflicting card (both cards reference each other)

  // Junction for notes in Pawkits
  collectionNotes CollectionNote[]

  // Citations (for topic notes)
  citations Citation[]

  @@index([workspaceId])
  @@index([workspaceId, deleted])
  @@index([workspaceId, type])
  @@index([workspaceId, scheduledDate])
  @@index([workspaceId, status])
  @@index([workspaceId, isRead])
  @@index([workspaceId, isDailyNote])
  @@index([workspaceId, linkStatus])
}

/// Collection - A Pawkit (folder/collection of cards)
/// Supports nesting, privacy, and board/kanban layouts
/// This is the ONLY folder system - notes and bookmarks both use Pawkits
model Collection {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Basic info
  name     String
  slug     String // Unique per workspace, used in URLs
  parentId String? // For nesting collections
  position Int     @default(0) // For ordering in sidebar

  // Display settings
  coverImage         String?
  coverImagePosition Int? // Y-offset for cover positioning
  icon               String? // Emoji icon

  // Privacy & System flags
  isPrivate Boolean @default(false) // Replaces Den - private collections
  isSystem  Boolean @default(false) // Cannot delete/rename (e.g., "Uncategorized")

  // Display options
  hidePreview          Boolean @default(false)
  useCoverAsBackground Boolean @default(false)

  // Board/Kanban configuration
  // Example: { defaultView: 'board', boardColumns: [{ id: 'todo', name: 'To Do', color: '#...' }, ...] }
  metadata Json?

  // Pinning
  pinned Boolean @default(false)

  // Soft delete
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  collectionNotes CollectionNote[]

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([workspaceId, deleted])
  @@index([workspaceId, parentId])
}

/// CollectionNote - Junction table for notes in multiple Pawkits
/// Enables a note to appear in multiple collections with independent ordering
model CollectionNote {
  id           String @id @default(cuid())
  collectionId String
  cardId       String
  position     Int    @default(0) // Order within the collection

  createdAt DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  card       Card       @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([collectionId, cardId])
  @@index([collectionId])
  @@index([cardId])
}

// =============================================================================
// STAGE 3: ORGANIZATION ENTITIES
// =============================================================================

/// CalendarEvent - Calendar entries with recurrence support
/// Can be standalone or linked to cards via source field
model CalendarEvent {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Event details
  title     String
  date      String // YYYY-MM-DD format for easy querying
  endDate   String? // For multi-day events, YYYY-MM-DD
  startTime String? // HH:mm format (null for all-day)
  endTime   String? // HH:mm format (null for all-day)
  isAllDay  Boolean @default(true)

  // Additional info
  description String?
  location    String?
  url         String? // Link to external resource
  color       String? // Hex color for display

  // Recurrence (RFC 5545 inspired)
  // Example: { freq: 'weekly', interval: 1, byDay: ['MO', 'WE', 'FR'], until: '2025-12-31' }
  recurrence         Json?
  recurrenceParentId String? // Links exception to parent recurring event
  excludedDates      String[] @default([]) // Dates to skip in recurrence
  isException        Boolean  @default(false) // True if this modifies a recurring instance

  // Source tracking
  // Example: { type: 'card', cardId: 'xxx' } or { type: 'manual' } or { type: 'kit' }
  source Json?

  // Soft delete
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId])
  @@index([workspaceId, date])
  @@index([workspaceId, deleted])
  @@index([recurrenceParentId])
}

/// Todo - Task items displayed in Home widget and Tasks modal
/// Can optionally link to cards
model Todo {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Task content
  text        String
  completed   Boolean   @default(false)
  completedAt DateTime?

  // Scheduling
  dueDate DateTime?

  // Priority: high, medium, low (null = no priority)
  priority String?

  // Link to related card (optional)
  linkedCardId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deleted   Boolean   @default(false)
  deletedAt DateTime?

  @@index([workspaceId])
  @@index([workspaceId, completed])
  @@index([workspaceId, dueDate])
}

// =============================================================================
// STAGE 4: FUTURE-READY ENTITIES
// =============================================================================

/// Connection - Cloud storage providers and MCP connections
/// For Filen, Google Drive, Dropbox, OneDrive, and MCP server
model Connection {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider: filen, google-drive, dropbox, onedrive, mcp
  provider String
  status   String // connected, disconnected, error

  // Provider-specific config (tokens, folder IDs, etc.)
  config Json?

  // For MCP server authentication
  apiToken     String? @unique
  apiTokenHash String?

  lastSyncAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([userId, provider])
  @@index([userId])
}

/// ConnectedAccount - Platform integrations for content import
/// For Reddit, YouTube, Twitter, HackerNews saved content
model ConnectedAccount {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Platform: reddit, youtube, twitter, hackernews
  platform         String
  platformUserId   String? // Platform-specific user ID
  platformUsername String? // Display name on platform

  // OAuth tokens (encrypted in production)
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?

  // Sync state
  lastSync   DateTime?
  syncCursor String? // Platform-specific pagination cursor
  syncStatus String    @default("idle") // idle, syncing, error
  lastError  String?

  // Platform-specific config
  // Example: { subreddits: ['r/programming'], playlists: ['PLxxx'] }
  config Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, platform])
  @@index([userId])
}

/// ImportJob - Bulk import tracking from connected platforms
/// Tracks progress of large import operations
model ImportJob {
  id          String @id @default(cuid())
  userId      String
  workspaceId String

  // Import source: reddit, youtube, twitter, etc.
  platform String

  // Job type: full-import, incremental, playlist-sync
  jobType String

  // Status: pending, running, completed, failed, cancelled
  status String

  // Progress tracking
  totalItems     Int?
  processedItems Int  @default(0)
  skippedItems   Int  @default(0)
  errorCount     Int  @default(0)

  // Error details (array of { item, error, timestamp })
  errors Json?

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([userId, status])
}

/// Citation - Source references for Topic Notes feature
/// Links notes to their source content (videos, articles, other notes)
model Citation {
  id     String @id @default(cuid())
  noteId String // The Topic Note containing this citation
  note   Card   @relation(fields: [noteId], references: [id], onDelete: Cascade)

  // Source type: youtube, reddit, twitter, article, note, card
  sourceType String
  sourceId   String? // Platform-specific ID or card ID
  sourceUrl  String?

  // Citation content
  quote     String? // Quoted text
  timestamp String? // Video timestamp like "2:34"
  author    String?

  // Platform-specific metadata (subreddit, channel name, etc.)
  platformMeta Json?

  // Order within the note
  position Int @default(0)

  createdAt DateTime @default(now())

  @@index([noteId])
  @@index([sourceType, sourceId])
}

/// QuickNoteArchive - Weekly consolidation of quick notes
/// Tracks which quick notes were merged into dated summary notes
model QuickNoteArchive {
  id          String @id @default(cuid())
  userId      String
  workspaceId String

  // The Monday of the archive week
  weekStart DateTime

  // The consolidated note that was created
  consolidatedNoteId String

  // IDs of quick notes that were merged
  sourceNoteIds String[]

  createdAt DateTime @default(now())

  @@unique([userId, workspaceId, weekStart])
  @@index([userId, workspaceId])
}

/// Reference - @ mention links between cards, Pawkits, and dates
/// Enables bidirectional linking (backlinks) and unified scheduling
model Reference {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Source: The card containing the @ mention
  sourceId String

  // Target: Card ID, Pawkit slug, or ISO date string (YYYY-MM-DD)
  targetId   String
  targetType String // 'card' | 'pawkit' | 'date'

  // Display text shown in the mention pill
  linkText String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sourceId])
  @@index([targetId, targetType])
  @@index([workspaceId])
  @@index([workspaceId, sourceId])
}

// =============================================================================
// NOTE: Device-specific settings are NOT in this schema
// They are stored in localStorage under key "pawkit_device_preferences":
// {
//   cardSize: 3,                    // Slider value (depends on screen size)
//   leftSidebarCollapsed: false,    // Depends on screen width
//   rightSidebarCollapsed: false,
//   leftSidebarAnchored: true,      // Depends on user's screen setup
//   rightSidebarAnchored: false
// }
// =============================================================================
